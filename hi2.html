<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Type Learning Game</title>
    <style>
        /* ... (Keep all existing CSS from the previous good version) ... */
         * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .instructions {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            color: #1976d2;
            border-left: 5px solid #2196f3;
        }
         .instructions ul {
            margin-left: 20px;
        }
        .instructions li {
            margin-bottom: 5px;
        }
        .instructions h3 {
            margin-bottom: 10px;
            color: #1565c0;
        }


        .data-split-info {
            background: #fff3e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            color: #e65100; /* Darker orange text */
            border-left: 5px solid #ff9800;
        }
         .data-split-info h3 {
            margin-bottom: 10px;
            color: #ef6c00; /* Slightly lighter orange for header */
        }


        .data-split-controls {
            text-align: center;
            margin: 20px 0;
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
        }

        .split-slider-container {
            margin: 15px 0;
        }

        .split-slider {
            width: 300px;
            margin: 10px auto;
            display: block;
        }

        .data-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-width: 120px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2196f3;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .training-mode-selector {
            text-align: center;
            margin: 20px 0;
        }

        .mode-btn {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #e0e0e0;
            color: #666;
        }

        .mode-btn.active {
            background: linear-gradient(45deg, #4caf50, #81c784);
            color: white;
            transform: scale(1.05);
        }

        .single-type-learning {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 10px;
        }

        .type-selector {
            text-align: center;
            margin-bottom: 20px;
        }

        .type-btn {
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            text-transform: uppercase;
        }

        .type-btn.fire {
            background: linear-gradient(45deg, #ff6b6b, #ff8787);
        }

        .type-btn.water {
            background: linear-gradient(45deg, #4ecdc4, #44a3aa);
        }

        .type-btn.grass {
            background: linear-gradient(45deg, #8bc34a, #7cb342);
        }

        .type-btn.dragon {
            background: linear-gradient(45deg, #7c4dff, #b388ff);
        }

        .type-btn.selected {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .feature-weights-display {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .weight-item {
            text-align: center;
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            min-width: 120px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .weight-bar-container {
            width: 100px;
            height: 150px;
            background: #e0e0e0;
            border-radius: 5px;
            margin: 10px auto;
            position: relative;
            overflow: hidden;
        }

        .weight-bar {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, #2196f3, #64b5f6);
            transition: height 0.5s ease;
            border-radius: 5px;
        }

        .weight-bar.negative {
            background: linear-gradient(to top, #f44336, #ef5350);
        }

        .weight-value {
            font-weight: bold;
            color: #333;
            margin-top: 5px;
        }

        .feature-label {
            font-size: 14px;
            font-weight: 600;
            color: #555;
        }

        .training-info {
            background: #e8f5e9;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            border-left: 5px solid #4caf50;
        }
         .training-info h4 { color: #388e3c; margin-bottom: 8px; }


        .bias-display {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #f0f0f0; /* Slightly different background */
            border-radius: 10px;
        }
        .bias-display label { font-weight: bold; color: #333; }

        .bias-value {
            font-size: 20px;
            font-weight: bold;
            color: #2196f3;
        }

        .importance-grid {
            display: grid;
            grid-template-columns: 120px repeat(8, 100px); /* Adjusted for 8 features */
            grid-template-rows: auto repeat(4, 80px); /* Header + 4 types */
            gap: 10px;
            margin: 30px auto;
            width: fit-content;
            background: #fafafa;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .grid-header {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #333;
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-size: 12px;
            word-break: break-word;
            text-align: center;
        }

        .type-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            padding: 10px;
            border-radius: 8px;
            color: white;
        }

        .type-label.fire { background: linear-gradient(45deg, #ff6b6b, #ff8787); }
        .type-label.water { background: linear-gradient(45deg, #4ecdc4, #44a3aa); }
        .type-label.grass { background: linear-gradient(45deg, #8bc34a, #7cb342); }
        .type-label.dragon { background: linear-gradient(45deg, #7c4dff, #b388ff); }

        .importance-cell {
            background: white;
            border-radius: 8px;
            padding: 10px;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .importance-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to top, #4caf50, #81c784);
            transition: height 0.5s ease;
            opacity: 0.8;
        }

        .importance-value {
            position: relative;
            z-index: 1;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .training-controls {
            text-align: center;
            margin: 30px 0;
        }

        .train-btn {
            padding: 12px 30px;
            margin: 5px; /* Adjusted for better wrapping on small screens */
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #4caf50, #81c784);
            color: white;
        }

        .train-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .train-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .test-btn {
            background: linear-gradient(45deg, #ff9800, #ffb74d);
        }
         .reset-btn { /* Style for the new reset button */
            background: linear-gradient(45deg, #f44336, #ef5350); 
        }
        .shuffle-btn {
             background: linear-gradient(45deg, #2196f3, #64b5f6);
        }


        .pokemon-queue {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .pokemon-queue h4, .pokemon-queue h5 {
            width: 100%;
            text-align: center;
            margin-bottom: 10px;
            color: #333;
        }


        .pokemon-training-card {
            background: white;
            border: 3px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: default; /* Not clickable individually */
            min-width: 120px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .pokemon-training-card.active { /* Highlight current training item */
            border-color: #4caf50;
            background: #e8f5e9;
            transform: scale(1.05);
        }

        .pokemon-training-card.trained { /* Dim already processed items */
            opacity: 0.6;
            border-color: #bdbdbd;
        }
        .pokemon-training-card.test-set {
            border-color: #ff9800;
            background: #fff8e1; /* Light orange */
        }
         .pokemon-training-card.train-set {
            border-color: #4caf50; /* Green border for training set cards */
            background: #e8f5e9; /* Light green */
        }


        .training-status {
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            color: #555;
        }

        .prediction-section {
            background: #f0f4f8;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
        }
         .prediction-section h3 {
            text-align: center;
            color: #1976d2;
            margin-bottom: 20px;
        }

        .prediction-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Wider cards */
            gap: 15px;
            margin-top: 20px;
        }

        .prediction-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .prediction-card h4 { margin-bottom: 10px; color: #333; }
        .prediction-card div { margin-bottom: 5px; }


        .prediction-score {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .prediction-score.correct { /* Changed from high/low */
            color: #4caf50;
        }

        .prediction-score.incorrect {  /* Changed from high/low */
            color: #f44336;
        }

        .learning-rate-control, .training-speed-control {
            text-align: center;
            margin: 20px 0;
        }

        .learning-rate-slider, .speed-slider {
            width: 300px;
            margin: 10px auto;
            display: block;
        }

        .epoch-counter {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: #2196f3;
            margin: 20px 0;
        }

        .accuracy-display {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 10px;
            border-left: 5px solid #4caf50;
        }
        .accuracy-display h3 { color: #388e3c; margin-bottom: 10px; }

        .accuracy-score {
            font-size: 28px;
            font-weight: bold;
            color: #2e7d32;
        }

        .single-type-data-strategy {
            margin: 20px 0;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 8px;
            border: 1px solid #bbdefb;
        }
        .single-type-data-strategy h4 {
            margin-bottom: 10px;
            color: #1565c0;
        }
        .single-type-data-strategy label {
            margin-right: 15px;
            cursor: pointer;
        }
        .strategy-option {
            display: block;
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 5px;
            background-color: #fff;
            border: 1px solid #ddd;
        }
        .strategy-option input[type="radio"] {
            margin-right: 8px;
        }
        .strategy-option.less-effective {
            border-left: 4px solid #ef5350; /* Red accent for less effective */
        }
        .strategy-option.more-effective {
            border-left: 4px solid #66bb6a; /* Green accent for more effective */
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>🎮 Pokémon AI Adventure - 2. Weight Training </h1>
        
        <div class="instructions">
            <h3>Welcome to the ML Pokemon Trainer!</h3>
            <ul>
                <li><strong>Single Type Mode:</strong>
                    <ul>
                    <li><em>Selected Type Only:</em> Trains only on examples of the chosen type (e.g., Fire). Useful for illustrating one-class learning, though less effective for classification.</li>
                    <li><em>All Types (Recommended):</em> Trains on all types, labeling the selected type as "positive" and others as "negative" to learn differentiation.</li>
                    </ul>
                </li>
                <li><strong>Multi Type Mode:</strong> Trains on all data to classify among all four types.</li>
            </ul>
        </div>
        
        <div class="data-split-info">
            <h3>📊 Train/Test Split Configuration</h3>
            <p>Splitting data ensures the model is tested on data it hasn't seen during training. This helps prevent "overfitting" (memorizing training data) and shows how well the model generalizes to new, unseen Pokémon.</p>
        </div>

        <div class="data-split-controls">
            <div class="split-slider-container">
                <label>Training Data Percentage: <span id="train-percentage">70</span>%</label>
                <input type="range" class="split-slider" id="train-split" 
                       min="50" max="90" step="5" value="70" 
                       oninput="updateTrainTestSplit(this.value)">
            </div>
            
            <div class="data-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-pokemon">0</div>
                    <div class="stat-label">Total Pokémon</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="train-count">0</div>
                    <div class="stat-label">Training Set</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="test-count">0</div>
                    <div class="stat-label">Test Set</div>
                </div>
            </div>
            
            <button class="train-btn shuffle-btn" onclick="regenerateDataSplit()">🔄 Shuffle Data & Reset Model</button>
        </div>

        <div class="training-mode-selector">
            <button class="mode-btn active" onclick="selectTrainingMode('single')">Single Type Training</button>
            <button class="mode-btn" onclick="selectTrainingMode('multi')">Multi Type Training</button>
        </div>

        <!-- Single Type Training -->
        <div id="single-type-training" class="training-mode-content">
            <div class="single-type-learning">
                <h3>Select Type for Single-Class Learning</h3>
                <div class="type-selector">
                    <button class="type-btn fire" onclick="selectTrainingType('fire')">🔥 Fire</button>
                    <button class="type-btn water" onclick="selectTrainingType('water')">💧 Water</button>
                    <button class="type-btn grass" onclick="selectTrainingType('grass')">🌿 Grass</button>
                    <button class="type-btn dragon" onclick="selectTrainingType('dragon')">🐉 Dragon</button>
                </div>

                <div class="single-type-data-strategy" id="single-data-strategy-selector" style="display:none;">
                    <h4>Single Type Training Data Strategy:</h4>
                    <label class="strategy-option less-effective">
                        <input type="radio" name="singleTypeStrategy" value="selectedOnly" checked onchange="updateSingleTypeStrategy()"> 
                        Train on Selected Type Only (One-Class Learning)
                        <p style="font-size:0.8em; color:#666; margin-top:3px;">Model sees only positive examples of the chosen type from the training set.</p>
                    </label>
                    <label class="strategy-option more-effective">
                        <input type="radio" name="singleTypeStrategy" value="allTypes" onchange="updateSingleTypeStrategy()"> 
                        Train on All Types (Binary Classification - Recommended)
                         <p style="font-size:0.8em; color:#666; margin-top:3px;">Model sees all types from training set; chosen type is 'positive', others are 'negative'.</p>
                    </label>
                </div>
                
                <div class="training-info" id="single-training-info" style="display: none;">
                    <h4>🎯 Model is learning to identify: <span id="selected-type-display"></span> Pokémon</h4>
                    <p id="single-training-data-description">It analyzes 4 features (HasWings, Speed, Attack, Defense) + Bias from <strong id="single-train-count">0</strong> <span id="selected-type-plural"></span> Pokémon in the training set.</p>
                    <p><em>Note: For Single Type Mode, weights (including Bias) are normalized to maintain a total absolute budget, causing them to fluctuate and compete.</em></p>
                </div>
                
                <div class="feature-weights-display" id="single-weights-display">
                    <!-- Weights will be dynamically generated -->
                </div>
                
                <div class="bias-display" id="single-bias-display" style="display: none;">
                    <label>Model Bias (Learned Threshold): </label>
                    <span class="bias-value" id="bias-value">0.000</span>
                </div>
            </div>
        </div>

        <!-- Multi Type Training -->
        <div id="multi-type-training" class="training-mode-content" style="display: none;">
            <h3 style="text-align: center;">Multi-Class Feature Importance Grid</h3>
             <div class="training-info" id="multi-training-info" style="display: none;">
                <h4>🎯 Model is learning to distinguish all 4 types.</h4>
                <p>It analyzes 8 features for each type using <strong id="multi-train-count">0</strong> Pokémon from the training set.</p>
                <p><em>Note: In Multi Type Mode, weights for each type/feature are learned independently and clipped to +/-1.</em></p>
            </div>
            <div class="importance-grid" id="importance-grid">
                <!-- Grid will be dynamically generated -->
            </div>
        </div>

        <div class="training-controls">
            <div class="learning-rate-control">
                <label>Learning Rate: <span id="learning-rate-value">0.1</span></label>
                <input type="range" class="learning-rate-slider" id="learning-rate" 
                       min="0.01" max="0.5" step="0.01" value="0.1" 
                       oninput="updateLearningRate(this.value)">
            </div>
            
            <div class="training-speed-control">
                <label>Training Iteration Speed: <span id="training-speed-value">500</span>ms</label>
                <input type="range" class="speed-slider" id="training-speed" 
                       min="50" max="2000" step="50" value="500" 
                       oninput="updateTrainingSpeed(this.value)">
            </div>
            
            <div class="epoch-counter">
                Epoch: <span id="epoch-count">0</span>
            </div>
            
            <button class="train-btn" id="start-train-btn" onclick="startTraining()">🚀 Start Training</button>
            <button class="train-btn" id="pause-train-btn" onclick="pauseTraining()" style="display:none;">⏸️ Pause Training</button>
            <button class="train-btn test-btn" onclick="testOnTestSet()">🧪 Evaluate on Test Set</button>
            <button class="train-btn reset-btn" onclick="justResetWeights()">🔄 Reset Model Weights</button>
        </div>

        <div class="training-status" id="training-status">
            Adjust settings and select a mode to begin.
        </div>

        <div class="pokemon-queue" id="pokemon-queue">
            <!-- Training queue will be shown here -->
        </div>

        <div class="accuracy-display" id="accuracy-display" style="display: none;">
            <h3>📈 Test Set Performance</h3>
            <div class="accuracy-score" id="accuracy-score">0%</div>
            <p id="accuracy-details">Correctly classified 0 out of 0 Pokémon.</p>
            <p>This is the model's performance on completely unseen data!</p>
        </div>

        <div class="prediction-section" id="prediction-section" style="display: none;">
            <h3>🔍 Test Set Predictions (Detailed)</h3>
            <div class="prediction-results" id="prediction-results">
                <!-- Predictions will be shown here -->
            </div>
        </div>
    </div>

    <script>
        // Game state
        let trainingMode = 'single';
        let selectedTrainingType = null;
        let singleTypeTrainingStrategy = 'selectedOnly'; 
        let learningRate = 0.1;
        let trainingSpeed = 500; 
        let epoch = 0;
        let isTraining = false;
        let currentTrainingItemIndex = 0; 
        let trainSplitPercentage = 70;
        
        let fullPokemonDataset = []; 
        let trainingData = [];
        let testData = [];
        let currentTrainingQueue = []; 

        const SINGLE_TYPE_WEIGHT_BUDGET = 2.5; // Target sum of absolute weights for single-type model
        
        const featureIcons = {
            'HasWings': '🦅', 'Speed': '⚡', 'Attack': '⚔️', 'Defense': '🛡️',
            'Weight': '⚖️', 'Height': '📏', 'HabitatAltitude': '🏔️', 'HabitatTemperature': '🌡️',
            'Bias': '🧠' 
        };
        
        let singleTypeWeights = {
            HasWings: 0, Speed: 0, Attack: 0, Defense: 0, Bias: 0
        };
        
        let multiTypeWeights = {
            fire: { HasWings: 0, Speed: 0, Attack: 0, Defense: 0, Weight: 0, Height: 0, HabitatAltitude: 0, HabitatTemperature: 0 },
            water: { HasWings: 0, Speed: 0, Attack: 0, Defense: 0, Weight: 0, Height: 0, HabitatAltitude: 0, HabitatTemperature: 0 },
            grass: { HasWings: 0, Speed: 0, Attack: 0, Defense: 0, Weight: 0, Height: 0, HabitatAltitude: 0, HabitatTemperature: 0 },
            dragon: { HasWings: 0, Speed: 0, Attack: 0, Defense: 0, Weight: 0, Height: 0, HabitatAltitude: 0, HabitatTemperature: 0 }
        };
        
        fullPokemonDataset = [
            // ... (Dataset remains the same)
            // FIRE POKEMON (35 total)
            {name: "Charizard", HasWings: 1, Speed: 8, Attack: 9, Defense: 4, Weight: 3, Height: 3, HabitatAltitude: 5, HabitatTemperature: 9, CorrectType: "fire"},
            {name: "Arcanine", HasWings: 0, Speed: 9, Attack: 8, Defense: 3, Weight: 4, Height: 4, HabitatAltitude: 4, HabitatTemperature: 8, CorrectType: "fire"},
            {name: "Moltres", HasWings: 1, Speed: 7, Attack: 9, Defense: 2, Weight: 2, Height: 3, HabitatAltitude: 9, HabitatTemperature: 10, CorrectType: "fire"},
            {name: "Typhlosion", HasWings: 0, Speed: 6, Attack: 8, Defense: 3, Weight: 3, Height: 3, HabitatAltitude: 5, HabitatTemperature: 9, CorrectType: "fire"},
            {name: "Blaziken", HasWings: 0, Speed: 8, Attack: 9, Defense: 2, Weight: 2, Height: 3, HabitatAltitude: 4, HabitatTemperature: 8, CorrectType: "fire"},
            {name: "Infernape", HasWings: 0, Speed: 9, Attack: 8, Defense: 3, Weight: 2, Height: 2, HabitatAltitude: 6, HabitatTemperature: 8, CorrectType: "fire"},
            {name: "Houndoom", HasWings: 0, Speed: 7, Attack: 9, Defense: 2, Weight: 3, Height: 2, HabitatAltitude: 5, HabitatTemperature: 9, CorrectType: "fire"},
            {name: "Magmortar", HasWings: 0, Speed: 5, Attack: 9, Defense: 3, Weight: 4, Height: 3, HabitatAltitude: 3, HabitatTemperature: 10, CorrectType: "fire"},
            {name: "Rapidash", HasWings: 0, Speed: 10, Attack: 8, Defense: 3, Weight: 3, Height: 3, HabitatAltitude: 5, HabitatTemperature: 8, CorrectType: "fire"},
            {name: "Flareon", HasWings: 0, Speed: 6, Attack: 9, Defense: 2, Weight: 2, Height: 1, HabitatAltitude: 4, HabitatTemperature: 9, CorrectType: "fire"},
            {name: "CameruptF", HasWings: 0, Speed: 4, Attack: 8, Defense: 3, Weight: 4, Height: 3, HabitatAltitude: 6, HabitatTemperature: 10, CorrectType: "fire"}, 
            {name: "Torkoal", HasWings: 0, Speed: 2, Attack: 7, Defense: 4, Weight: 4, Height: 2, HabitatAltitude: 7, HabitatTemperature: 9, CorrectType: "fire"},
            {name: "Magcargo", HasWings: 0, Speed: 3, Attack: 8, Defense: 3, Weight: 3, Height: 2, HabitatAltitude: 8, HabitatTemperature: 10, CorrectType: "fire"},
            {name: "Entei", HasWings: 0, Speed: 8, Attack: 9, Defense: 3, Weight: 4, Height: 4, HabitatAltitude: 6, HabitatTemperature: 9, CorrectType: "fire"},
            {name: "Ho-Oh", HasWings: 1, Speed: 9, Attack: 9, Defense: 4, Weight: 4, Height: 4, HabitatAltitude: 10, HabitatTemperature: 9, CorrectType: "fire"},
            {name: "Talonflame", HasWings: 1, Speed: 10, Attack: 8, Defense: 2, Weight: 2, Height: 2, HabitatAltitude: 8, HabitatTemperature: 8, CorrectType: "fire"},
            {name: "Delphox", HasWings: 0, Speed: 6, Attack: 8, Defense: 3, Weight: 3, Height: 3, HabitatAltitude: 4, HabitatTemperature: 8, CorrectType: "fire"},
            {name: "Pyroar", HasWings: 0, Speed: 8, Attack: 8, Defense: 3, Weight: 4, Height: 3, HabitatAltitude: 5, HabitatTemperature: 9, CorrectType: "fire"},
            {name: "Volcanion", HasWings: 0, Speed: 7, Attack: 9, Defense: 4, Weight: 4, Height: 3, HabitatAltitude: 9, HabitatTemperature: 10, CorrectType: "fire"},
            {name: "Incineroar", HasWings: 0, Speed: 6, Attack: 9, Defense: 3, Weight: 4, Height: 3, HabitatAltitude: 4, HabitatTemperature: 8, CorrectType: "fire"},
            {name: "Cinderace", HasWings: 0, Speed: 10, Attack: 9, Defense: 2, Weight: 2, Height: 2, HabitatAltitude: 4, HabitatTemperature: 8, CorrectType: "fire"},
            {name: "Centiskorch", HasWings: 0, Speed: 6, Attack: 9, Defense: 3, Weight: 3, Height: 6, HabitatAltitude: 3, HabitatTemperature: 9, CorrectType: "fire"},
            {name: "Coalossal", HasWings: 0, Speed: 3, Attack: 8, Defense: 4, Weight: 5, Height: 5, HabitatAltitude: 7, HabitatTemperature: 10, CorrectType: "fire"},
            {name: "Ninetales", HasWings: 0, Speed: 8, Attack: 8, Defense: 3, Weight: 2, Height: 2, HabitatAltitude: 6, HabitatTemperature: 8, CorrectType: "fire"},
            {name: "Growlithe", HasWings: 0, Speed: 7, Attack: 7, Defense: 2, Weight: 2, Height: 1, HabitatAltitude: 4, HabitatTemperature: 8, CorrectType: "fire"},
            
            // WATER POKEMON (35 total)
            {name: "Blastoise", HasWings: 0, Speed: 5, Attack: 3, Defense: 8, Weight: 8, Height: 7, HabitatAltitude: 2, HabitatTemperature: 3, CorrectType: "water"},
            {name: "Lapras", HasWings: 0, Speed: 4, Attack: 3, Defense: 7, Weight: 9, Height: 9, HabitatAltitude: 1, HabitatTemperature: 2, CorrectType: "water"},
            {name: "Vaporeon", HasWings: 0, Speed: 6, Attack: 2, Defense: 8, Weight: 7, Height: 8, HabitatAltitude: 2, HabitatTemperature: 3, CorrectType: "water"},
            {name: "Gyarados", HasWings: 0, Speed: 5, Attack: 4, Defense: 7, Weight: 9, Height: 10, HabitatAltitude: 3, HabitatTemperature: 4, CorrectType: "water"},
            {name: "Golduck", HasWings: 0, Speed: 7, Attack: 3, Defense: 7, Weight: 7, Height: 7, HabitatAltitude: 3, HabitatTemperature: 4, CorrectType: "water"},
            {name: "Tentacruel", HasWings: 0, Speed: 6, Attack: 2, Defense: 8, Weight: 6, Height: 8, HabitatAltitude: 1, HabitatTemperature: 3, CorrectType: "water"},
            {name: "Slowbro", HasWings: 0, Speed: 2, Attack: 3, Defense: 9, Weight: 8, Height: 7, HabitatAltitude: 2, HabitatTemperature: 3, CorrectType: "water"},
            {name: "Cloyster", HasWings: 0, Speed: 7, Attack: 3, Defense: 10, Weight: 7, Height: 6, HabitatAltitude: 1, HabitatTemperature: 2, CorrectType: "water"},
            {name: "Starmie", HasWings: 0, Speed: 9, Attack: 2, Defense: 7, Weight: 7, Height: 7, HabitatAltitude: 2, HabitatTemperature: 3, CorrectType: "water"},
            {name: "Seaking", HasWings: 0, Speed: 6, Attack: 3, Defense: 6, Weight: 6, Height: 6, HabitatAltitude: 3, HabitatTemperature: 4, CorrectType: "water"},
            {name: "Dewgong", HasWings: 0, Speed: 5, Attack: 2, Defense: 8, Weight: 8, Height: 7, HabitatAltitude: 1, HabitatTemperature: 1, CorrectType: "water"},
            {name: "KinglerW", HasWings: 0, Speed: 5, Attack: 4, Defense: 9, Weight: 6, Height: 6, HabitatAltitude: 2, HabitatTemperature: 3, CorrectType: "water"},
            {name: "Politoed", HasWings: 0, Speed: 5, Attack: 3, Defense: 7, Weight: 6, Height: 6, HabitatAltitude: 3, HabitatTemperature: 4, CorrectType: "water"},
            {name: "Azumarill", HasWings: 0, Speed: 4, Attack: 2, Defense: 7, Weight: 5, Height: 7, HabitatAltitude: 3, HabitatTemperature: 4, CorrectType: "water"},
            {name: "Quagsire", HasWings: 0, Speed: 3, Attack: 3, Defense: 8, Weight: 7, Height: 6, HabitatAltitude: 2, HabitatTemperature: 3, CorrectType: "water"},
            {name: "Corsola", HasWings: 0, Speed: 3, Attack: 2, Defense: 8, Weight: 5, Height: 5, HabitatAltitude: 1, HabitatTemperature: 2, CorrectType: "water"},
            {name: "Mantine", HasWings: 1, Speed: 7, Attack: 2, Defense: 7, Weight: 9, Height: 9, HabitatAltitude: 2, HabitatTemperature: 3, CorrectType: "water"},
            {name: "KingdraW", HasWings: 0, Speed: 7, Attack: 3, Defense: 8, Weight: 8, Height: 7, HabitatAltitude: 3, HabitatTemperature: 4, CorrectType: "water"},
            {name: "Suicune", HasWings: 0, Speed: 8, Attack: 3, Defense: 9, Weight: 8, Height: 8, HabitatAltitude: 4, HabitatTemperature: 2, CorrectType: "water"},
            {name: "Milotic", HasWings: 0, Speed: 6, Attack: 2, Defense: 7, Weight: 8, Height: 10, HabitatAltitude: 3, HabitatTemperature: 3, CorrectType: "water"},
            {name: "Walrein", HasWings: 0, Speed: 4, Attack: 3, Defense: 8, Weight: 9, Height: 8, HabitatAltitude: 1, HabitatTemperature: 1, CorrectType: "water"},
            {name: "Huntail", HasWings: 0, Speed: 4, Attack: 4, Defense: 8, Weight: 6, Height: 7, HabitatAltitude: 1, HabitatTemperature: 2, CorrectType: "water"},
            {name: "Gorebyss", HasWings: 0, Speed: 5, Attack: 3, Defense: 8, Weight: 5, Height: 7, HabitatAltitude: 1, HabitatTemperature: 2, CorrectType: "water"},
            {name: "Luvdisc", HasWings: 0, Speed: 8, Attack: 1, Defense: 5, Weight: 3, Height: 4, HabitatAltitude: 2, HabitatTemperature: 3, CorrectType: "water"},
            {name: "Empoleon", HasWings: 0, Speed: 6, Attack: 3, Defense: 8, Weight: 8, Height: 8, HabitatAltitude: 1, HabitatTemperature: 1, CorrectType: "water"},
            
            // GRASS POKEMON (35 total)
            {name: "Venusaur", HasWings: 0, Speed: 5, Attack: 3, Defense: 8, Weight: 4, Height: 8, HabitatAltitude: 4, HabitatTemperature: 3, CorrectType: "grass"},
            {name: "Vileplume", HasWings: 0, Speed: 4, Attack: 2, Defense: 7, Weight: 2, Height: 6, HabitatAltitude: 5, HabitatTemperature: 3, CorrectType: "grass"},
            {name: "Exeggutor", HasWings: 0, Speed: 4, Attack: 2, Defense: 7, Weight: 4, Height: 8, HabitatAltitude: 6, HabitatTemperature: 2, CorrectType: "grass"},
            {name: "Tangela", HasWings: 0, Speed: 5, Attack: 2, Defense: 9, Weight: 3, Height: 5, HabitatAltitude: 7, HabitatTemperature: 3, CorrectType: "grass"},
            {name: "Meganium", HasWings: 0, Speed: 5, Attack: 3, Defense: 8, Weight: 3, Height: 7, HabitatAltitude: 4, HabitatTemperature: 2, CorrectType: "grass"},
            {name: "Bellossom", HasWings: 0, Speed: 5, Attack: 2, Defense: 7, Weight: 2, Height: 4, HabitatAltitude: 5, HabitatTemperature: 3, CorrectType: "grass"},
            {name: "Jumpluff", HasWings: 0, Speed: 8, Attack: 2, Defense: 7, Weight: 1, Height: 5, HabitatAltitude: 8, HabitatTemperature: 4, CorrectType: "grass"},
            {name: "Sunflora", HasWings: 0, Speed: 3, Attack: 3, Defense: 6, Weight: 2, Height: 5, HabitatAltitude: 4, HabitatTemperature: 2, CorrectType: "grass"},
            {name: "Sceptile", HasWings: 0, Speed: 9, Attack: 3, Defense: 6, Weight: 3, Height: 7, HabitatAltitude: 5, HabitatTemperature: 3, CorrectType: "grass"},
            {name: "Shiftry", HasWings: 0, Speed: 7, Attack: 4, Defense: 6, Weight: 4, Height: 6, HabitatAltitude: 7, HabitatTemperature: 4, CorrectType: "grass"},
            {name: "Tropius", HasWings: 1, Speed: 5, Attack: 3, Defense: 8, Weight: 5, Height: 8, HabitatAltitude: 6, HabitatTemperature: 2, CorrectType: "grass"},
            {name: "Cradily", HasWings: 0, Speed: 3, Attack: 3, Defense: 9, Weight: 5, Height: 6, HabitatAltitude: 3, HabitatTemperature: 3, CorrectType: "grass"},
            {name: "Ludicolo", HasWings: 0, Speed: 6, Attack: 2, Defense: 7, Weight: 4, Height: 6, HabitatAltitude: 4, HabitatTemperature: 3, CorrectType: "grass"},
            {name: "Breloom", HasWings: 0, Speed: 6, Attack: 4, Defense: 6, Weight: 3, Height: 5, HabitatAltitude: 8, HabitatTemperature: 3, CorrectType: "grass"},
            {name: "Roserade", HasWings: 0, Speed: 7, Attack: 2, Defense: 8, Weight: 2, Height: 5, HabitatAltitude: 5, HabitatTemperature: 3, CorrectType: "grass"},
            {name: "Cacturne", HasWings: 0, Speed: 5, Attack: 4, Defense: 6, Weight: 3, Height: 6, HabitatAltitude: 9, HabitatTemperature: 2, CorrectType: "grass"},
            {name: "Leafeon", HasWings: 0, Speed: 7, Attack: 3, Defense: 8, Weight: 2, Height: 4, HabitatAltitude: 4, HabitatTemperature: 3, CorrectType: "grass"},
            {name: "Abomasnow", HasWings: 0, Speed: 4, Attack: 3, Defense: 7, Weight: 6, Height: 8, HabitatAltitude: 10, HabitatTemperature: 1, CorrectType: "grass"},
            {name: "Torterra", HasWings: 0, Speed: 5, Attack: 4, Defense: 9, Weight: 7, Height: 8, HabitatAltitude: 5, HabitatTemperature: 3, CorrectType: "grass"},
            {name: "Cherrim", HasWings: 0, Speed: 6, Attack: 2, Defense: 7, Weight: 2, Height: 4, HabitatAltitude: 6, HabitatTemperature: 2, CorrectType: "grass"},
            {name: "Tangrowth", HasWings: 0, Speed: 4, Attack: 3, Defense: 9, Weight: 5, Height: 8, HabitatAltitude: 7, HabitatTemperature: 3, CorrectType: "grass"},
            {name: "Serperior", HasWings: 0, Speed: 8, Attack: 2, Defense: 8, Weight: 4, Height: 9, HabitatAltitude: 4, HabitatTemperature: 3, CorrectType: "grass"},
            {name: "Whimsicott", HasWings: 0, Speed: 9, Attack: 1, Defense: 7, Weight: 1, Height: 3, HabitatAltitude: 7, HabitatTemperature: 4, CorrectType: "grass"},
            {name: "Lilligant", HasWings: 0, Speed: 7, Attack: 2, Defense: 7, Weight: 2, Height: 5, HabitatAltitude: 5, HabitatTemperature: 3, CorrectType: "grass"},
            {name: "Ferrothorn", HasWings: 0, Speed: 2, Attack: 3, Defense: 10, Weight: 6, Height: 5, HabitatAltitude: 3, HabitatTemperature: 2, CorrectType: "grass"},
            
            // DRAGON POKEMON (35 total)
            {name: "Dragonite", HasWings: 1, Speed: 8, Attack: 9, Defense: 8, Weight: 8, Height: 9, HabitatAltitude: 8, HabitatTemperature: 4, CorrectType: "dragon"},
            {name: "Garchomp", HasWings: 0, Speed: 9, Attack: 9, Defense: 8, Weight: 8, Height: 8, HabitatAltitude: 7, HabitatTemperature: 3, CorrectType: "dragon"},
            {name: "Salamence", HasWings: 1, Speed: 9, Attack: 9, Defense: 7, Weight: 8, Height: 7, HabitatAltitude: 9, HabitatTemperature: 3, CorrectType: "dragon"},
            {name: "Rayquaza", HasWings: 1, Speed: 9, Attack: 10, Defense: 8, Weight: 9, Height: 10, HabitatAltitude: 10, HabitatTemperature: 2, CorrectType: "dragon"},
            {name: "KingdraD", HasWings: 0, Speed: 7, Attack: 8, Defense: 8, Weight: 8, Height: 7, HabitatAltitude: 6, HabitatTemperature: 4, CorrectType: "dragon"},
            {name: "Altaria", HasWings: 1, Speed: 6, Attack: 6, Defense: 8, Weight: 6, Height: 5, HabitatAltitude: 9, HabitatTemperature: 3, CorrectType: "dragon"},
            {name: "Flygon", HasWings: 1, Speed: 8, Attack: 8, Defense: 7, Weight: 8, Height: 8, HabitatAltitude: 7, HabitatTemperature: 2, CorrectType: "dragon"},
            {name: "Latias", HasWings: 1, Speed: 10, Attack: 7, Defense: 9, Weight: 7, Height: 6, HabitatAltitude: 10, HabitatTemperature: 3, CorrectType: "dragon"},
            {name: "Latios", HasWings: 1, Speed: 10, Attack: 8, Defense: 8, Weight: 7, Height: 7, HabitatAltitude: 10, HabitatTemperature: 3, CorrectType: "dragon"},
            {name: "Dialga", HasWings: 0, Speed: 7, Attack: 9, Defense: 9, Weight: 10, Height: 9, HabitatAltitude: 8, HabitatTemperature: 1, CorrectType: "dragon"},
            {name: "Palkia", HasWings: 0, Speed: 8, Attack: 9, Defense: 8, Weight: 9, Height: 8, HabitatAltitude: 9, HabitatTemperature: 2, CorrectType: "dragon"},
            {name: "Giratina", HasWings: 1, Speed: 7, Attack: 8, Defense: 9, Weight: 10, Height: 10, HabitatAltitude: 10, HabitatTemperature: 1, CorrectType: "dragon"},
            {name: "Haxorus", HasWings: 0, Speed: 8, Attack: 10, Defense: 7, Weight: 8, Height: 7, HabitatAltitude: 6, HabitatTemperature: 3, CorrectType: "dragon"},
            {name: "Hydreigon", HasWings: 1, Speed: 8, Attack: 9, Defense: 7, Weight: 8, Height: 7, HabitatAltitude: 7, HabitatTemperature: 2, CorrectType: "dragon"},
            {name: "Reshiram", HasWings: 1, Speed: 8, Attack: 9, Defense: 8, Weight: 9, Height: 9, HabitatAltitude: 9, HabitatTemperature: 3, CorrectType: "dragon"},
            {name: "Zekrom", HasWings: 1, Speed: 8, Attack: 10, Defense: 9, Weight: 9, Height: 9, HabitatAltitude: 9, HabitatTemperature: 2, CorrectType: "dragon"},
            {name: "Kyurem", HasWings: 1, Speed: 8, Attack: 9, Defense: 8, Weight: 9, Height: 8, HabitatAltitude: 10, HabitatTemperature: 1, CorrectType: "dragon"},
            {name: "Goodra", HasWings: 0, Speed: 6, Attack: 8, Defense: 9, Weight: 8, Height: 8, HabitatAltitude: 4, HabitatTemperature: 3, CorrectType: "dragon"},
            {name: "Noivern", HasWings: 1, Speed: 10, Attack: 7, Defense: 7, Weight: 7, Height: 7, HabitatAltitude: 8, HabitatTemperature: 3, CorrectType: "dragon"},
            {name: "Zygarde", HasWings: 0, Speed: 8, Attack: 8, Defense: 9, Weight: 9, Height: 9, HabitatAltitude: 7, HabitatTemperature: 2, CorrectType: "dragon"},
            {name: "Drampa", HasWings: 1, Speed: 4, Attack: 7, Defense: 8, Weight: 8, Height: 8, HabitatAltitude: 8, HabitatTemperature: 3, CorrectType: "dragon"},
            {name: "Kommo-o", HasWings: 0, Speed: 7, Attack: 8, Defense: 9, Weight: 7, Height: 7, HabitatAltitude: 6, HabitatTemperature: 4, CorrectType: "dragon"},
            {name: "Jangmo-o", HasWings: 0, Speed: 5, Attack: 6, Defense: 6, Weight: 5, Height: 4, HabitatAltitude: 6, HabitatTemperature: 4, CorrectType: "dragon"},
            {name: "Hakamo-o", HasWings: 0, Speed: 6, Attack: 7, Defense: 7, Weight: 6, Height: 5, HabitatAltitude: 6, HabitatTemperature: 4, CorrectType: "dragon"},
            {name: "Dragapult", HasWings: 1, Speed: 10, Attack: 9, Defense: 7, Weight: 7, Height: 8, HabitatAltitude: 8, HabitatTemperature: 2, CorrectType: "dragon"},
            ];

        // --- DATA SPLIT FUNCTIONS ---
        function updateTrainTestSplit(percentage) {
            trainSplitPercentage = parseInt(percentage);
            document.getElementById('train-percentage').textContent = percentage;
            generateDataSplit(); 
            resetModelAndUI();   
        }

        function generateDataSplit() {
            const shuffled = shuffleArray([...fullPokemonDataset]);
            const totalPokemon = shuffled.length;
            const trainSize = Math.floor(totalPokemon * trainSplitPercentage / 100);
            
            trainingData = shuffled.slice(0, trainSize);
            testData = shuffled.slice(trainSize);
            
            updateDataStatsAndInfo(); 
            displayDataSplitInQueue(); 
        }

        function regenerateDataSplit() {
            generateDataSplit();
            resetModelAndUI(); 
            document.getElementById('training-status').textContent = 'Data reshuffled and model reset. Ready to train.';
        }

        function updateDataStatsAndInfo() {
            document.getElementById('total-pokemon').textContent = fullPokemonDataset.length;
            document.getElementById('train-count').textContent = trainingData.length;
            document.getElementById('test-count').textContent = testData.length;

            if (trainingMode === 'single' && selectedTrainingType) {
                let countForInfo;
                let strategyDescription;
                if (singleTypeTrainingStrategy === 'selectedOnly') {
                    countForInfo = trainingData.filter(p => p.CorrectType === selectedTrainingType).length;
                    strategyDescription = `Model will see <strong>only these ${countForInfo}</strong> ${selectedTrainingType} Pokémon from the training set.`;
                } else { 
                    countForInfo = trainingData.length; 
                    const positiveExamples = trainingData.filter(p => p.CorrectType === selectedTrainingType).length;
                    strategyDescription = `Model will see <strong>all ${countForInfo}</strong> training Pokémon (${positiveExamples} are ${selectedTrainingType}, others are negative examples).`;
                }
                document.getElementById('single-train-count').textContent = countForInfo; 
                document.getElementById('single-training-data-description').innerHTML = strategyDescription;

            } else if (trainingMode === 'multi') {
                 document.getElementById('multi-train-count').textContent = trainingData.length;
            }
        }

        function displayDataSplitInQueue() {
            const queueDiv = document.getElementById('pokemon-queue');
            queueDiv.innerHTML = ''; 

            const addHeader = (text, color) => {
                const header = document.createElement('h4');
                header.textContent = text;
                header.style.color = color;
                queueDiv.appendChild(header);
            };
            
            addHeader(`🎯 Training Set (${trainingData.length} Pokémon)`, '#388e3c');
            trainingData.forEach(p => queueDiv.appendChild(createPokemonCard(p, 'train-set')));
            
            addHeader(`🧪 Test Set (${testData.length} Pokémon - Unseen by Model)`, '#ef6c00');
            testData.forEach(p => queueDiv.appendChild(createPokemonCard(p, 'test-set')));
        }
        
        function displayActiveTrainingQueue() {
            const queueDiv = document.getElementById('pokemon-queue');
            queueDiv.innerHTML = ''; 
            
            let headerText = `🎯 Training (Epoch ${epoch + 1})`;
            if (trainingMode === 'single') {
                 headerText += `: Learning ${selectedTrainingType.toUpperCase()} Type`;
                 if (singleTypeTrainingStrategy === 'selectedOnly') headerText += " (Selected Type Only)";
                 else headerText += " (All Types)";
            } else {
                 headerText += `: Learning All Types`;
            }

            const activeHeader = document.createElement('h4');
            activeHeader.textContent = headerText;
            activeHeader.style.color = '#1565c0';
            queueDiv.appendChild(activeHeader);

            currentTrainingQueue.forEach((pokemon, index) => {
                const card = createPokemonCard(pokemon, 'train-set'); 
                if (index === currentTrainingItemIndex && isTraining) card.classList.add('active');
                if (index < currentTrainingItemIndex) card.classList.add('trained');
                queueDiv.appendChild(card);
            });
        }


        function createPokemonCard(pokemon, setClass) { 
            const card = document.createElement('div');
            card.className = `pokemon-training-card ${setClass}`;
            
            const typeEmojis = { 'fire': '🔥', 'water': '💧', 'grass': '🌿', 'dragon': '🐉' };
            const setName = setClass === 'test-set' ? 'TEST' : 'TRAIN';
            
            card.innerHTML = `
                <div>${typeEmojis[pokemon.CorrectType] || '❓'}</div>
                <div>${pokemon.name}</div>
                <div style="font-size: 11px; color: #555; margin-top: 3px;">(${pokemon.CorrectType.toUpperCase()})</div>
                 <div style="font-size: 10px; color: ${setClass === 'test-set' ? '#ef6c00' : '#388e3c'}; font-weight:bold;">${setName}</div>
            `;
            return card;
        }

        // --- UI AND MODE SELECTION ---
        function updateSingleTypeStrategy() {
            singleTypeTrainingStrategy = document.querySelector('input[name="singleTypeStrategy"]:checked').value;
            justResetWeights(); 
            updateDataStatsAndInfo(); 
            document.getElementById('training-status').textContent = `Single type strategy changed. Model weights reset.`;
        }


        function selectTrainingMode(mode) {
            trainingMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.mode-btn[onclick="selectTrainingMode('${mode}')"]`).classList.add('active');
            
            document.getElementById('single-type-training').style.display = mode === 'single' ? 'block' : 'none';
            document.getElementById('multi-type-training').style.display = mode === 'multi' ? 'block' : 'none';
            document.getElementById('single-data-strategy-selector').style.display = mode === 'single' ? 'block' : 'none';
            
            if (mode === 'single') {
                if (!selectedTrainingType) { 
                     document.getElementById('single-weights-display').innerHTML = '<p style="color:#555;">Select a type above to configure.</p>';
                     document.getElementById('single-bias-display').style.display = 'none';
                     document.getElementById('single-training-info').style.display = 'none';
                     document.getElementById('single-data-strategy-selector').style.display = 'none';
                } else {
                    updateSingleTypeDisplay(); 
                    document.getElementById('single-bias-display').style.display = 'block';
                    document.getElementById('single-training-info').style.display = 'block';
                    document.getElementById('single-data-strategy-selector').style.display = 'block';
                }
                 document.getElementById('multi-training-info').style.display = 'none';
            } else { 
                initializeImportanceGrid(); 
                document.getElementById('single-training-info').style.display = 'none';
                document.getElementById('single-bias-display').style.display = 'none';
                document.getElementById('multi-training-info').style.display = 'block';

            }
            updateDataStatsAndInfo(); 
            resetModelAndUI(); 
        }
        
        function selectTrainingType(type) {
            selectedTrainingType = type;
            document.querySelectorAll('#single-type-training .type-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            
            document.getElementById('single-training-info').style.display = 'block';
            document.getElementById('selected-type-display').textContent = type.charAt(0).toUpperCase() + type.slice(1);
            document.getElementById('selected-type-plural').textContent = type; 

            document.getElementById('single-bias-display').style.display = 'block';
            document.getElementById('single-data-strategy-selector').style.display = 'block'; 
            
            updateDataStatsAndInfo(); 
            resetModelAndUI();
            updateSingleTypeDisplay(); 
        }
        
        function updateLearningRate(value) {
            learningRate = parseFloat(value);
            document.getElementById('learning-rate-value').textContent = value;
        }
        
        function updateTrainingSpeed(value) {
            trainingSpeed = parseInt(value);
            document.getElementById('training-speed-value').textContent = value;
        }

        // --- WEIGHTS DISPLAY AND GRID ---
        function initializeImportanceGrid() {
            const grid = document.getElementById('importance-grid');
            grid.innerHTML = '';
            
            grid.appendChild(createGridCell('', 'grid-header')); 
            const features = ['HasWings', 'Speed', 'Attack', 'Defense', 'Weight', 'Height', 'HabitatAltitude', 'HabitatTemperature'];
            features.forEach(feature => {
                const cell = createGridCell(`${featureIcons[feature]}<br>${feature}`, 'grid-header');
                grid.appendChild(cell);
            });
            
            ['fire', 'water', 'grass', 'dragon'].forEach(type => {
                const typeEmojis = { 'fire': '🔥 Fire', 'water': '💧 Water', 'grass': '🌿 Grass', 'dragon': '🐉 Dragon' };
                grid.appendChild(createGridCell(typeEmojis[type], `type-label ${type}`));
                
                features.forEach(feature => {
                    const importanceCell = document.createElement('div');
                    importanceCell.className = 'importance-cell';
                    importanceCell.id = `importance-${type}-${feature}`;
                    importanceCell.innerHTML = `<div class="importance-fill"></div><div class="importance-value">0.00</div>`;
                    grid.appendChild(importanceCell);
                });
            });
            updateMultiTypeDisplay(); 
        }
        
        function createGridCell(content, className) {
            const cell = document.createElement('div');
            cell.className = className;
            cell.innerHTML = content;
            return cell;
        }
        
        function updateSingleTypeDisplay() {
            const display = document.getElementById('single-weights-display');
            display.innerHTML = '';
            
            if (!selectedTrainingType && trainingMode === 'single') {
                display.innerHTML = '<p style="color:#555;">Select a type to see its feature weights and bias.</p>';
                if(document.getElementById('single-bias-display')) document.getElementById('single-bias-display').style.display = 'none';
                return;
            }
             if (document.getElementById('single-bias-display')) document.getElementById('single-bias-display').style.display = 'block';


            const featuresForSingle = ['HasWings', 'Speed', 'Attack', 'Defense']; 
            featuresForSingle.forEach(feature => {
                const weightItem = document.createElement('div');
                weightItem.className = 'weight-item';
                const weight = singleTypeWeights[feature];
                const normalizedWeightPercent = Math.abs(weight) * 100; 
                
                weightItem.innerHTML = `
                    <div class="feature-label">${featureIcons[feature]} ${feature}</div>
                    <div class="weight-bar-container">
                        <div class="weight-bar ${weight < 0 ? 'negative' : ''}" style="height: ${normalizedWeightPercent}%"></div>
                    </div>
                    <div class="weight-value">${weight.toFixed(3)}</div>`;
                display.appendChild(weightItem);
            });
            
            if (document.getElementById('bias-value')) {
                document.getElementById('bias-value').textContent = singleTypeWeights.Bias.toFixed(3);
            }
        }
        
        function updateMultiTypeDisplay() {
            const featuresForMulti = ['HasWings', 'Speed', 'Attack', 'Defense', 'Weight', 'Height', 'HabitatAltitude', 'HabitatTemperature'];
            ['fire', 'water', 'grass', 'dragon'].forEach(type => {
                featuresForMulti.forEach(feature => {
                    const cell = document.getElementById(`importance-${type}-${feature}`);
                    if (cell) {
                        const weight = multiTypeWeights[type][feature];
                        const fill = cell.querySelector('.importance-fill');
                        const value = cell.querySelector('.importance-value');
                        
                        const normalizedWeightPercent = Math.abs(weight) * 100; 
                        fill.style.height = `${normalizedWeightPercent}%`;
                        fill.style.background = weight >= 0 
                            ? 'linear-gradient(to top, #4caf50, #81c784)' 
                            : 'linear-gradient(to top, #f44336, #ef5350)';
                        value.textContent = weight.toFixed(2);
                    }
                });
            });
        }

        // --- MODEL TRAINING AND STATE ---
        function justResetWeights() { 
            pauseTraining(); 
            epoch = 0;
            document.getElementById('epoch-count').textContent = epoch;
            
            Object.keys(singleTypeWeights).forEach(k => singleTypeWeights[k] = 0);
            Object.keys(multiTypeWeights).forEach(type => {
                Object.keys(multiTypeWeights[type]).forEach(k => multiTypeWeights[type][k] = 0);
            });
            
            if (trainingMode === 'single') {
                updateSingleTypeDisplay();
            } else {
                updateMultiTypeDisplay();
            }
            
            document.getElementById('training-status').textContent = 'Model weights reset.';
            document.getElementById('prediction-section').style.display = 'none';
            document.getElementById('accuracy-display').style.display = 'none';
        }

        function resetModelAndUI() { 
            justResetWeights();
            displayDataSplitInQueue(); 
        }
        
        function startTraining() {
            if (trainingMode === 'single' && !selectedTrainingType) {
                alert('Please select a type for Single Type Training!');
                return;
            }
            if (trainingData.length === 0) {
                alert('No training data! Please check the data split.');
                return;
            }

            if (trainingMode === 'single') {
                if (singleTypeTrainingStrategy === 'selectedOnly') {
                    currentTrainingQueue = trainingData.filter(p => p.CorrectType === selectedTrainingType);
                } else { 
                    currentTrainingQueue = shuffleArray([...trainingData]); 
                }
                if (currentTrainingQueue.length === 0) {
                    alert(`No Pokémon for training with selected strategy. If using "Selected Type Only", ensure ${selectedTrainingType} Pokémon are in the training set. Try shuffling or adjusting split.`);
                    return;
                }
            } else { 
                currentTrainingQueue = shuffleArray([...trainingData]);
            }
            
            isTraining = true;
            currentTrainingItemIndex = 0;
            epoch = 0; 
            document.getElementById('epoch-count').textContent = epoch;
            
            document.getElementById('start-train-btn').style.display = 'none';
            document.getElementById('pause-train-btn').style.display = 'inline-block';
            document.getElementById('training-status').textContent = 'Training started...';
            
            displayActiveTrainingQueue();
            trainNextItem();
        }
        
        function pauseTraining() {
            isTraining = false;
            document.getElementById('start-train-btn').style.display = 'inline-block';
            document.getElementById('pause-train-btn').style.display = 'none';
            document.getElementById('training-status').textContent = 'Training paused.';
        }
        
        function shuffleArray(array) {
            let newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function applyWeightClipping(weightObject, key) {
            weightObject[key] = Math.max(-1, Math.min(1, weightObject[key]));
        }

        function normalizeSingleTypeWeights() {
            let sumAbsWeights = 0;
            const weightKeys = ['HasWings', 'Speed', 'Attack', 'Defense', 'Bias'];
            weightKeys.forEach(key => {
                sumAbsWeights += Math.abs(singleTypeWeights[key]);
            });

            if (sumAbsWeights > 0 && sumAbsWeights !== SINGLE_TYPE_WEIGHT_BUDGET) {
                const scaleFactor = SINGLE_TYPE_WEIGHT_BUDGET / sumAbsWeights;
                weightKeys.forEach(key => {
                    singleTypeWeights[key] *= scaleFactor;
                    applyWeightClipping(singleTypeWeights, key); // Re-clip after scaling
                });
            }
        }
        
        function trainNextItem() {
            if (!isTraining) return;

            if (currentTrainingItemIndex >= currentTrainingQueue.length) {
                epoch++;
                document.getElementById('epoch-count').textContent = epoch;
                currentTrainingItemIndex = 0;
                currentTrainingQueue = shuffleArray(currentTrainingQueue); 
            }
            
            if (currentTrainingQueue.length === 0) { 
                pauseTraining();
                document.getElementById('training-status').textContent = 'Training stopped: No items in queue.';
                return;
            }

            const pokemon = currentTrainingQueue[currentTrainingItemIndex];
            document.getElementById('training-status').textContent = 
                `Learning from ${pokemon.name} (${pokemon.CorrectType}). Epoch: ${epoch + 1}`;
            
            if (trainingMode === 'single') {
                trainSingleTypeLogic(pokemon);
            } else {
                trainMultiTypeLogic(pokemon);
            }
            
            displayActiveTrainingQueue(); 
            currentTrainingItemIndex++;
            
            if (isTraining) {
                setTimeout(trainNextItem, trainingSpeed);
            }
        }
        
        function trainSingleTypeLogic(pokemon) {
            const features = {
                HasWings: pokemon.HasWings, Speed: pokemon.Speed / 10,
                Attack: pokemon.Attack / 10, Defense: pokemon.Defense / 10
            };
            
            let rawScore = singleTypeWeights.Bias;
            Object.keys(features).forEach(f => rawScore += singleTypeWeights[f] * features[f]);
            
            const prediction = 1 / (1 + Math.exp(-rawScore)); 
            
            let target;
            if (singleTypeTrainingStrategy === 'selectedOnly') {
                target = 1; 
            } else { 
                target = (pokemon.CorrectType === selectedTrainingType) ? 1 : 0;
            }
            
            const error = target - prediction;
            const gradient = error * prediction * (1 - prediction); 
            
            Object.keys(features).forEach(f => {
                singleTypeWeights[f] += learningRate * gradient * features[f];
                applyWeightClipping(singleTypeWeights, f); 
            });
            singleTypeWeights.Bias += learningRate * gradient * 1; 
            applyWeightClipping(singleTypeWeights, 'Bias'); 
            
            normalizeSingleTypeWeights(); // Apply the budget constraint

            updateSingleTypeDisplay();
        }
        
        function trainMultiTypeLogic(pokemon) {
            const features = {
                HasWings: pokemon.HasWings, Speed: pokemon.Speed / 10, Attack: pokemon.Attack / 10, 
                Defense: pokemon.Defense / 10, Weight: pokemon.Weight / 10, Height: pokemon.Height / 10, 
                HabitatAltitude: pokemon.HabitatAltitude / 10, HabitatTemperature: pokemon.HabitatTemperature / 10
            };
            
            ['fire', 'water', 'grass', 'dragon'].forEach(type => {
                let rawScore = 0; 
                Object.keys(features).forEach(f => rawScore += multiTypeWeights[type][f] * features[f]);
                
                const prediction = 1 / (1 + Math.exp(-rawScore));
                const target = pokemon.CorrectType === type ? 1 : 0;
                const error = target - prediction;
                const gradient = error * prediction * (1 - prediction);
                
                Object.keys(features).forEach(f => {
                    multiTypeWeights[type][f] += learningRate * gradient * features[f];
                    applyWeightClipping(multiTypeWeights[type], f); 
                });
            });
            updateMultiTypeDisplay();
        }

        // --- TESTING AND PREDICTION ---
        function testOnTestSet() {
            if (testData.length === 0) {
                alert('No test data available! Please check the data split.');
                return;
            }
            pauseTraining(); 

            document.getElementById('prediction-section').style.display = 'block';
            document.getElementById('accuracy-display').style.display = 'block';
            const resultsDiv = document.getElementById('prediction-results');
            resultsDiv.innerHTML = '';
            
            let correctCount = 0;
            
            testData.forEach(pokemon => {
                const card = document.createElement('div');
                card.className = 'prediction-card';
                let isCorrectPrediction = false; // Renamed for clarity
                
                if (trainingMode === 'single') {
                    if (!selectedTrainingType) {
                        resultsDiv.innerHTML = "<p>Please select a type for single-type mode first.</p>"; return;
                    }
                    const confidence = predictSingleTypeScore(pokemon);
                    const predictedAsSelectedType = confidence > 0.5;
                    const actualIsSelectedType = pokemon.CorrectType === selectedTrainingType;
                    isCorrectPrediction = predictedAsSelectedType === actualIsSelectedType;
                    
                    let rawScore = singleTypeWeights.Bias; 
                    const pFeatures = { HasWings: pokemon.HasWings, Speed: pokemon.Speed/10, Attack: pokemon.Attack/10, Defense: pokemon.Defense/10};
                    Object.keys(pFeatures).forEach(f => rawScore += singleTypeWeights[f] * pFeatures[f]);

                    card.innerHTML = `
                        <h4>${pokemon.name} 🧪</h4>
                        <div>Actual: ${pokemon.CorrectType}</div>
                        <div>Model testing for: ${selectedTrainingType}</div>
                        <div>Prediction: ${predictedAsSelectedType ? `IS ${selectedTrainingType}` : `NOT ${selectedTrainingType}`}</div>
                        <div class="prediction-score ${isCorrectPrediction ? 'correct' : 'incorrect'}">
                            Confidence: ${(confidence * 100).toFixed(1)}%
                        </div>
                         <div style="font-size: 11px; color: #666; margin-top: 5px; padding: 5px; background: #f9f9f9; border-radius: 4px;">
                            Raw Score: ${rawScore.toFixed(3)} (Bias ${singleTypeWeights.Bias.toFixed(3)})<br>
                            Sigmoid(${rawScore.toFixed(3)}) = ${confidence.toFixed(3)}
                        </div>
                        <div>${isCorrectPrediction ? '✅ Correct' : '❌ Wrong'}</div>`;
                } else { 
                    const predictions = predictMultiTypeScores(pokemon);
                    const predictedType = Object.keys(predictions).reduce((a, b) => 
                        predictions[a] > predictions[b] ? a : b);
                    isCorrectPrediction = predictedType === pokemon.CorrectType;
                    
                    card.innerHTML = `
                        <h4>${pokemon.name} 🧪</h4>
                        <div>Actual: ${pokemon.CorrectType}</div>
                        <div>Predicted: ${predictedType}</div>
                        <div class="prediction-score ${isCorrectPrediction ? 'correct' : 'incorrect'}">
                           Confidence: ${(predictions[predictedType] * 100).toFixed(1)}%
                        </div>
                        <div>${isCorrectPrediction ? '✅ Correct' : '❌ Wrong'}</div>`;
                }
                if (isCorrectPrediction) correctCount++;
                resultsDiv.appendChild(card);
            });
            
            const accuracy = testData.length > 0 ? (correctCount / testData.length * 100) : 0;
            document.getElementById('accuracy-score').textContent = `${accuracy.toFixed(1)}%`;
            document.getElementById('accuracy-details').textContent = `Correctly classified ${correctCount} out of ${testData.length} Pokémon.`;
            document.getElementById('accuracy-score').style.color = 
                accuracy >= 70 ? '#2e7d32' : accuracy >= 50 ? '#f57c00' : '#d32f2f';
        }
        
        function predictSingleTypeScore(pokemon) { 
            const features = {
                HasWings: pokemon.HasWings, Speed: pokemon.Speed / 10,
                Attack: pokemon.Attack / 10, Defense: pokemon.Defense / 10
            };
            let rawScore = singleTypeWeights.Bias;
            Object.keys(features).forEach(f => rawScore += singleTypeWeights[f] * features[f]);
            return 1 / (1 + Math.exp(-rawScore));
        }
        
        function predictMultiTypeScores(pokemon) { 
            const features = {
                HasWings: pokemon.HasWings, Speed: pokemon.Speed / 10, Attack: pokemon.Attack / 10, 
                Defense: pokemon.Defense / 10, Weight: pokemon.Weight / 10, Height: pokemon.Height / 10, 
                HabitatAltitude: pokemon.HabitatAltitude / 10, HabitatTemperature: pokemon.HabitatTemperature / 10
            };
            const predictions = {};
            ['fire', 'water', 'grass', 'dragon'].forEach(type => {
                let rawScore = 0;
                Object.keys(features).forEach(f => rawScore += multiTypeWeights[type][f] * features[f]);
                predictions[type] = 1 / (1 + Math.exp(-rawScore));
            });
            return predictions;
        }
        
        // --- INITIALIZATION ---
        window.onload = function() {
            generateDataSplit(); 
            selectTrainingMode('single'); 
            document.getElementById('training-status').textContent = 'Game loaded. Configure settings and start training!';
        };
    </script>
</body>
</html>